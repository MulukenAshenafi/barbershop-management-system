# =============================================================================
# LOCAL DEVELOPMENT ONLY – Backend + PostgreSQL (Docker)
# =============================================================================
# Use this for local dev: `docker compose up --build`
# For Render: deploy the backend as a Web Service (Dockerfile in backend/);
# use Render's free-tier PostgreSQL and set DB_* env vars – do NOT use this
# Compose file on Render.
# =============================================================================

services:
  db:
    image: postgis/postgis:15-3.3-alpine
    container_name: bsbs_db
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - bsbs_network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bsbs_backend
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3 --timeout 120
    environment:
      DB_HOST: db
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: 5432
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-*}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      FIREBASE_CREDENTIALS: ${FIREBASE_CREDENTIALS}
      CLOUDINARY_NAME: ${CLOUDINARY_NAME:-}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY:-}
      CLOUDINARY_SECRET: ${CLOUDINARY_SECRET:-}
      CHAPA_SECRET_KEY: ${CHAPA_SECRET_KEY:-}
      CHAPA_PUBLIC_KEY: ${CHAPA_PUBLIC_KEY:-}
      CHAPA_WEBHOOK_SECRET: ${CHAPA_WEBHOOK_SECRET:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
    # Local dev only: persist static/media in named volumes. On Render, no volumes;
    # static served by WhiteNoise, media by Cloudinary or S3.
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - bsbs_network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local

networks:
  bsbs_network:
    driver: bridge
